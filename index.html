<!DOCTYPE html>
<html>

<head>

  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript" src="jquery.js"></script>
	<Title> Assignment2 </Title>
</head>
<body>
<div id="buttons">
    <input name="previousButton" type="button" value="Previous Year" onclick="ChangeYear(-1)" />
    <input name="nextButton" type="button" value="Next Year" onclick="ChangeYear(1)" />
    <input name="Select Year" type="button" value="Select Year" onclick="Select()" />
    <input name="text" type="text"  id="text"/>
    <input name="AnimationButton" type="button" value="Show Me The Change From 1900 to 2016" onclick="Animation()" />
    <input name="Stop" type="button" value="Stop!" onclick="Animation()" />
    
   
</div>


<script type = "text/javascript">

var Data = "Gapminder_All_Time.csv";

//margin for main svg
var margin = {top: 50, right: 20, bottom: 50, left: 50},
    width = 1000 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

// the tab for showing the information of the selected circle
var informationTab = d3.select("body").append("div")
    .attr("class", "informationTab")
    .style("opacity", 0);


// the main svg
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
// svg for bar charts 
var svgForBar1 = d3.select("body").append("svg")
    .attr("width", 400)
    .attr("height", 600)
    .attr("style","outline: 5px solid #630");

var year = 1900;

var color = d3.scale.category10();
// scale for gdp and xaxis
var xScale = d3.scale.linear().domain([60000, 0]).range([width, 0]),
xAxis = d3.svg.axis().scale(xScale).orient("bottom").tickFormat(d3.format("d"));
// scale for life and yaxis
var yScale = d3.scale.linear().domain([15, 90]).range([height, 0]), // value -> display
yAxis = d3.svg.axis().scale(yScale).orient("left");

//x axis
 svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .append("text")
      .attr("class", "label")
      .attr("x", width)
      .attr("y", -6)
      .style("text-anchor", "end")
      .text("GDP");

//y axis
svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
      .append("text")
      .attr("class", "label")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Life expectancy");

// function for travel from 1900 - 2016
function Animation(){
  
  for(var i=0;i<72;i++){
    ChangeYear(1);
    setInterval(1000);
  }
  
}

// function for choose a specific year to view the data
function Select(){
    var temp = $('#text').val();
    if(temp>1950) year = temp-1;
    else year = temp - 10;
    ChangeYear(1);
}
// funcion to change the main graph
function ChangeYear(x){
  //console.log(year);
d3.csv(Data, function(error, data){
 
      
      svg.select("#circles").remove();
      svg.select("#title").remove();
      //deal with 1900->1910->1920..
      if(year<1950)
        year = year + 10 * x;
      else
        year = year + x;

      if ((year<1900) || (year>2016)){
        if(x == 1) year = 1900;
        if(x == -1) year = 2016;        
      }

      var y = year.toString();



      //console.log(y);
      //prepare the data for each country every year.
      var yearGDP = [];
      var yearHealth = [];
      var yearPopulation = [];
      var region = [];
      var Countries = new Array();
      
        data.forEach(function (d) {
          if (d.Year == y) {
          if(Countries.indexOf(d.Country) == -1)
            Countries.push(d.Country);
          }
        });
      

      data.forEach(function(d){
        if (d.Year == y) {
          if (Countries.indexOf(d.Country)!=-1){
            if (isNaN(+d.GDP)) yearGDP.push(0);
            else yearGDP.push(+d.GDP);
          }
        }
      });

      data.forEach(function(d){
      if (d.Year==y){
        if (Countries.indexOf(d.Country)!=-1){
          //console.log(d.LifeExp)
          if (d.LifeExp==".."){
            yearHealth.push(0);
          }
          else yearHealth.push(+d.LifeExp);
        }
      }
      });

      data.forEach(function(d){
        if (d.Year == y) {
        if (Countries.indexOf(d.Country)!=-1){
          if (isNaN(+d.Population)) yearPopulation.push(0);
          else yearPopulation.push(+d.Population);
        }
        }
      });

      
        for (var c in Countries) {
          //console.log(Countries[c]);
          var notFound = true;
          data.forEach(function (d) {
            if (notFound) {
              if (d.Country == Countries[c]) {
                region.push(d.Region);
                notFound = false;
              }
            }
          });
          if (notFound) {
            region.push("Unknown");
          }
        };
     
      // It's like when year is 2016 allData for China is [China, China's GDP, Life, population, asia]
      var allData = d3.zip(Countries, yearGDP, yearHealth, yearPopulation, region);

      var circle = svg.append("g").attr("id", "circles")
        .selectAll("circle")
        .data(allData)
        .enter().append("circle")
        .attr("cx", function(d) {return xScale(d[1]);})
        .attr("cy", function(d) {return yScale(d[2]);})
        .attr("class", "y1")
        .attr("r", function(d){return Math.pow(d[3], 1/2)/600;})
        .style("fill", function(d) { return color(d[4]);})
        .style("stroke", "black")
        
        // show information tab
        .on("mouseover", function(d) {
          informationTab.transition()
               .duration(200)
               .style("opacity", .9);
          informationTab.html(d[0] + "<br/> " + "GDP: " + d[1] + "<br/>" + " Life Expectancy: " + d[2] + "<br/>" + " Population: " + d[3] + "<br/>" + "Continent: " + d[4])
        })
        .on("mouseout", function(d) {
          informationTab.transition()
               .duration(500)
               .style("opacity", 0)
        });

        
        //set the year and the position
        var title = svg.append("g").attr("id", "title")
          .append("text")
          .attr("x", width-300)           
          .attr("y", height-150)
          .style("font-size", "65px") 
          .text("Year: " + y);
        
      });
    
};

ChangeYear(0);





</script>

</body>

</html>