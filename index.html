<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script type="text/javascript" src="./d3/d3.v4.js" charset="utf-8"></script>
  <script type="text/javascript" src="jquery.js"></script>
  <style type="text/css">
    .axis path,
    .axis line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }
  
    .axis text {
      font-family: sans-serif;
      font-size: 11px;
    }
  </style>
	<Title> Assignment2 </Title>
</head>
<body>
<div id="buttons">
    <input name="previousButton" type="button" value="Previous Year" onclick="ChangeYear(-1)" />
    <input name="nextButton" type="button" value="Next Year" onclick="ChangeYear(1)" />
    <input name="Select Year" type="button" value="Select Year" onclick="Select()" />
    <input name="text" type="text"  id="text"/>
    <input name="AnimationButton" type="button" value="Show Me The Change From 1900 to 2016" onclick="Animation()" />
    <input name="Stop" type="button" value="Stop!" onclick="stopRunning()" /> 
    
</div>


<script type = "text/javascript" >

var Data = "Gapminder_All_Time.csv";

//margin for main svg
var margin = {top: 50, right: 20, bottom: 50, left: 50},
    width = 1000 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;


//Width and height
var outer_width = 500;
var outer_height = 400;
var svg_width = outer_width - 30;
var svg_height = outer_height - 30;

// the tab for showing the information of the selected circle
var informationTab = d3.select("body").append("div")
    .attr("class", "informationTab")
    .style("opacity", 1);


// the main svg
var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// svg for bar charts 
  var svg1 = d3.select("body")
    .append("svg")
    .attr("width", svg_width + margin.left + margin.right)
    .attr("height", svg_height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    .attr("class", "chart");

  //svg for another bar charts
  var svg2 = d3.select("body")
      .append("svg")
      .attr("width", svg_width + margin.left + margin.right)
      .attr("height", svg_height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
      .attr("class", "chart");


var year = 1900;
// to control the animation
var keepRunning = true;

var color = d3.scale.category10();
/********************

Scale and axis for main graph part

**********/
// scale for gdp and xaxis
var xScale = d3.scale.linear().domain([60000, 0]).range([width, 0]),
xAxis = d3.svg.axis().scale(xScale).orient("bottom").tickFormat(d3.format("d"));
// scale for life and yaxis
var yScale = d3.scale.linear().domain([15, 90]).range([height, 0]), // value -> display
yAxis = d3.svg.axis().scale(yScale).orient("left");

  //main x axis
  svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis)
    .append("text")
    .attr("class", "label")
    .attr("x", width)
    .attr("y", -6)
    .style("text-anchor", "end")
    .text("GDP");

  //main y axis
  svg.append("g")
    .attr("class", "y axis")
    .call(yAxis)
    .append("text")
    .attr("class", "label")
    .attr("transform", "rotate(-90)")
    .attr("y", 6)
    .attr("dy", ".71em")
    .style("text-anchor", "end")
    .text("Life expectancy");

  svg.append("text")
    .attr("id", "newyear")
    .attr("text-anchor", "end")
    .attr("x", 650)
    .attr("y", 325)
    .style("opacity", 0.4)
    .attr("font-size", "250px")
    .text(+year);


/********************

Scale and axis for main graph part


**********/
//xscale for bar chart
 	// Create a scale to scale market share values nicely for bar heights
    var baryScale = d3.scale.linear()
      .domain([60,0])
      .range([svg_height-100,0]);
    
    var baryScale1 = d3.scale.linear().domain([125,0]).range([svg_height-100,0]);


    // Create a scale object to nicely take care of positioning bars along the horizontal axis
    // We don't set the domain yet as data isn't loaded
    var GovermentNames = new Array("islamic republic", "republic", "monarchy", "external territory"
        , "federal republic", "absolute monarchy", "people's republic", "socialist republic", "parliamentary federal republic");
    var barxScale = d3.scale.ordinal()
      .range([0, 400], 0.1);
    var barxScale1 = d3.scale.ordinal().range([GovermentNames],1);

    //Define Y axis
    var baryAxis = d3.svg.axis().scale(baryScale).ticks(5).orient("left");
    var baryAxis1 = d3.svg.axis().scale(baryScale1).ticks(12).orient("left");



    // Create an x-axis connected to the x scale
    var barxAxis = d3.svg.axis().scale(barxScale).orient("bottom");
    var barxAxis = d3.svg.axis().scale(barxScale1).orient("bottom");

    // Call the y axis
    svg1.append("g")
      .attr("class", "axis")
      .attr("id", "y-axis")
      .call(baryAxis)
      .append("text")
      .attr("transform", "rotate(-60)")
      .style("text-anchor", "front")
      .text("Regions");

    // All but call the x-axis
    svg1.append("g")
      .attr("class", "axis")
      .attr("id", "x-axis")
      .call(barxAxis);


  // Call the y axis
  svg2.append("g")
    .attr("class", "axis")
    .attr("id", "y-axis")
    .call(baryAxis1)
    .append("text")
    .attr("transform", "rotate(-60)")
      .style("text-anchor", "front")
    .text("Governments");

  // All but call the x-axis
  svg2.append("g")
    .attr("class", "axis")
    .attr("id", "x-axis")
    .call(barxAxis);


// function for travel from 1900 - 2016
function Animation(){
  keepRunning = true;
  setInterval(function(){
    if(keepRunning == true){
      ChangeYear(1);
    }
    else{
      return false;
    }
      
  }, 1000);

  
}

function stopRunning(){
  keepRunning = false;
}

// function for choose a specific year to view the data
function Select(){
    var temp = $('#text').val();
    if(temp>1950) year = temp-1;
    else year = temp - 10;
    ChangeYear(1);
}

// funcion to change the main graph
function ChangeYear(x){
  //console.log(year);
  d3.csv(Data, function(error, data){
 
      
      svg.select("#circles").remove();
      svg.select("#title").remove();
      //deal with 1900->1910->1920..
      if(year<1950)
        year = year + 10 * x;
      else
        year = year + x;

      if ((year<1900) || (year>2016)){
        if(x == 1) year = 1900;
        if(x == -1) year = 2016;        
      }

      var y = year.toString();



      //prepare the data for each country every year.
      var yearGDP = [];
      var yearHealth = [];
      var yearPopulation = [];
      var region = [];
      var Countries = new Array();
      
      // 0-7 for Asia   Europe   Africa   North America   Central America   South America   Oceania   Australia
      var Regions = new Array(0, 0, 0, 0, 0, 0, 0, 0);
      var RegionNames = new Array("Asia", "Europe", "Africa", "North America", "Central America", "South America", "Oceania", "Australia");
      // 0-8 for islamic republic    republic    monarchy   external territory    federal republic   
      // absolute monarchy   people's republic    socialist republic   parliamentary federal republic
      var Goverment = new Array(0, 0, 0, 0, 0, 0, 0, 0, 0);
      var GovermentNames = new Array("islamic republic", "republic", "monarchy", "external territory"
      , "federal republic", "absolute monarchy", "people's republic", "socialist republic", "parliamentary federal republic");
      
      
     
      
      data.forEach(function (d) {
        if (d.Year == y) {
        if(Countries.indexOf(d.Country) == -1)
          Countries.push(d.Country);
        }
      });
      

      data.forEach(function(d){
        if (d.Year == y) {
          if (Countries.indexOf(d.Country)!=-1){
            if (isNaN(+d.GDP)) yearGDP.push(0);
            else yearGDP.push(+d.GDP);
          }
        }
      });

      data.forEach(function(d){
      if (d.Year==y){
        if (Countries.indexOf(d.Country)!=-1){
          //console.log(d.LifeExp)
          if (d.LifeExp==".."){
            yearHealth.push(0);
          }
          else yearHealth.push(+d.LifeExp);
        }
      }
      });

      data.forEach(function(d){
        if (d.Year == y) {
        if (Countries.indexOf(d.Country)!=-1){
          if (isNaN(+d.Population)) yearPopulation.push(0);
          else yearPopulation.push(+d.Population);
        }
        }
      });

      
      for (var c in Countries) {
        //console.log(Countries[c]);
        var notFound = true;
        data.forEach(function (d) {
          if (notFound) {
            if (d.Country == Countries[c]) {
              region.push(d.Region);
              notFound = false;
            }
          }
        });
        if (notFound) {
          region.push("Unknown");
        }
      };
      
      // prepare the array for region and goverment for part two
      for (var c in Countries) {
        //console.log(Countries[c]);
        data.forEach(function (d) {
            if (d.Country == Countries[c] && d.Year == y) {
              switch (d.Region) {
                case "Asia":
                  Regions[0]++;
                  break;
                case "Europe":
                  Regions[1]++;
                  break;
                case "Africa":
                  Regions[2]++;
                  break;
                case "North America":
                  Regions[3]++;
                  break;
                case "Central America":
                  Regions[4]++;
                  break;
                case "South America":
                  Regions[5]++;
                  break;
                case "Oceania":
                  Regions[6]++;
                  break;
                case "Australia":
                  Regions[7]++;
                  break;
              }
              switch (d.Government) {
                case "islamic republic":
                  Goverment[0]++;
                  break;
                case "republic":
                  Goverment[1]++;
                  break;
                case "monarchy":
                  Goverment[2]++;
                  break;
                case "external territory":
                  Goverment[3]++;
                  break;
                case "federal republic":
                  Goverment[4]++;
                  break;
                case "absolute monarchy":
                  Goverment[5]++;
                  break;
                case "people's republic":
                  Goverment[6]++;
                  break;
                case "socialist republic":
                  Goverment[7]++;
                  break;
                case "parliamentary federal republic":
                  Goverment[8]++;
                  break;
               
              }
            }
            
          
        });
        
     };
    //console.log(Regions[1]);

     
      // It's like when year is 2016 allData for China is [China, China's GDP, Life, population, asia]
      var allData = d3.zip(Countries, yearGDP, yearHealth, yearPopulation, region);
      var dataForBar1 = d3.zip(RegionNames,Regions);
      var dataForBar2 = d3.zip(GovermentNames,Goverment);
      console.log(allData);
      generateVis(dataForBar1);
      generateVis1(dataForBar2);
      //BarChart(dataForBar1,dataForBar2);
      var circle = svg.append("g").attr("id", "circles")
        .selectAll("circle")
        .data(allData)
        .enter().append("circle")
        .style("fill", function (d) { return color(d[4]); })
        .on("mouseover", function (d) {
          informationTab.transition()
            .duration(200)
            .style("opacity", .9);
          informationTab.html(d[0] + "<br/> " + "GDP: " + d[1] + "<br/>" + " Life Expectancy: " + d[2] + "<br/>" + " Population: " + d[3] + "<br/>" + "Continent: " + d[4])
        })
        .on("mouseout", function (d) {
          informationTab.transition()
            .duration(500)
            .style("opacity", 0)
        })
        .transition()
        .duration(500)
        .attr("cx", function(d) {return xScale(d[1]);})
        .attr("cy", function(d) {return yScale(d[2]);})
        .attr("class", "y1")
        .attr("r", function(d){return Math.pow(d[3], 1/2)/600;})
        .style("stroke", "white")
        .style("stroke-size","3px")
        .style("opacity", 0.8);

        
        //set the year and the position
       d3.select("#newyear").text(y)
        
      });
    
};

//Bar chart No.1
function generateVis(data) {

  //console.log(data);

  // Filter the data to only include the current year

  /******** PERFORM DATA JOIN ************/
  // Join new data with old elements, if any.
  var bars = svg1.selectAll("rect")
    .data(data);



  /******** HANDLE ENTER SELECTION ************/
  // Create new elements in the dataset
  bars.enter()
    .append("rect")
    .attr("x", function (d,i) {
      return 52*i;
    })
    .attr("y",0)
    .attr("width", 37)
    .attr("height", function (d) {
      return baryScale(d[1]);
    })
    .style("fill", "Blue")
    .append("text")
    .text(function(d){
      return d;
    });

  // Set the year label
}
//bar chart No.2
  function generateVis1(data) {

    //console.log(data);

    // Filter the data to only include the current year

    /******** PERFORM DATA JOIN ************/
    // Join new data with old elements, if any.
    var bars = svg2.selectAll("rect")
      .data(data);



    /******** HANDLE ENTER SELECTION ************/
    // Create new elements in the dataset
    bars.enter()
      .append("rect")
      .attr("x", function (d, i) {
        return 45 * i;
      })
      .attr("y", 0)
      .attr("width", 39)
      .attr("height", function (d) {
        return baryScale1(d[1]);
      })
      .style("fill", "Blue");
/*
      d3.svg2.selectAll("text")
          .data(data)
          .enter()
          .append("text")
          .attr("fill", "black")
          .attr("x", function (d, i) {
            return 45 * i;
          })
          .attr("y", 0)
          .html(function (d) {
            return d[0];
          });
*/

  }
ChangeYear(0);





</script>

</body>

</html>